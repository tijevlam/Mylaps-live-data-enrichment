<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MYLAPS T&S TCP-IP Monitor</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.5.0/build/global/luxon.min.js"></script>
    <link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
    <link href="https://history.hollandtriathlon.nl/assets/css/tabulator_materialize.css" rel="stylesheet">
        <script>
        let countries;

        async function fetchCountries() {
            const response = await fetch('https://challengealmere.s3.eu-west-1.amazonaws.com/2023/countries2023.json');
            return response.json();
        }


        let domiciles;

        async function fetchDomiciles() {
            const response = await fetch('https://challengealmere.s3.eu-west-1.amazonaws.com/2023/domicilies2023.json');
            return response.json();
        }

        let startlist;
        async function fetchStartlist() {
            const response = await fetch('https://challengealmere.s3.eu-west-1.amazonaws.com/2023/startlist2023.json');
            return response.json();
        }

        let table;

    </script>
</head>
<body>
    <h1>MYLAPS T&S TCP-IP Monitor</h1>
    <div id="mylaps" class="table tabulator"></div>
    <script>
        async function main(){
            countries = await fetchCountries();
            domiciles = await fetchDomiciles();
            startlist = await fetchStartlist();


            table = new Tabulator("#mylaps", {
                columns:[
                    {title:"Bib", field:"bib", sorter:"number" },
                    {title:"Chip Code", field:"chipcode", sorter:"alphanum", visible:false },
                    {title:"Function", field:"function", sorter:"string", visible:false },
                    {title:"Source Name", field:"sourceName", sorter:"string"},
                    {title:"Name", field:"name", sorter:"string"},
                    {title:"Wave", field:"wave", sorter:"string"},
                    {title:"Cat", field:"cat", sorter:"string"},
                    {title:"Laps", field:"laps", sorter:"number"},
                    {title:"Time", field:"time", sorter:"time"},
                    {title:"Race Time", field:"raceTime", sorter:"time"},
                    {title:"Info", field:"info", sorter:"string"},
                    {title:"SI", field: "si"}
                ],
                height:"100%",
                maxHeight:"100%",
                pagination:"local",
                paginationSize:20,
                paginationSizeSelector:false,
                dataTree:true,
                dataTreeStartExpanded:false,
            });

            const socket = io();
            const messageList = document.getElementById('message-list');

            function displayMessage(message) {
                let tableBody = document.querySelector('#message-list tbody');
                let cTime = luxon.DateTime.fromISO(`2024-09-14T${message.t}`);
                let startTime = luxon.DateTime.fromISO("2024-09-14T07:00:00.000");

                function formatTime(seconds) {
                    const hours = Math.floor(seconds / 3600);
                    const minutes = Math.floor((seconds % 3600) / 60);
                    const remainingSeconds = Math.floor(seconds % 60);

                    const formattedHours = String(hours).padStart(2, '0');
                    const formattedMinutes = String(minutes).padStart(2, '0');
                    const formattedSeconds = String(remainingSeconds).padStart(2, '0');

                    return `${formattedHours}:${formattedMinutes}:${formattedSeconds}`;
                }


                let pdata = {
                    bib: message.Bib,
                    chipcode: message.c,
                    function: message.function,
                    sourceName: message.sourceName,
                    name: message.Name,
                    wave: message.Wave,
                    cat: message.Cat,
                    laps: message.l,
                    time: message.t ? message.t.split(".")[0] : "",
                    raceTime: formatTime(cTime.diff(startTime, 'seconds').toObject().seconds),
                    info: message.Info
                };

                if (startlist.find(s => s.bibnr == message.Bib)) {
                    Object.assign(pdata, startlist.find(s => s.bibnr == message.Bib));
                }

                 return pdata;


                /*
                const row = document.createElement('tr');
                row.innerHTML = `<td>${message.b}</td>
                    <td>${message.c}</td>
                    <td>${message.function}</td>
                    <td>${message.sourceName}</td>
                    <td>&nbsp;</td>
                    <td>${message.l}</td>
                    <td>${message.t ? message.t.split(".")[0] : ""}</td>
                    <td>${formatTime(cTime.diff(startTime, 'seconds').toObject().seconds)}</td>`;
                tableBody.prepend(row);

                if ( document.getElementById("message-list").rows.length > 41) {
                    if(document.getElementById("message-list").rows[42]) {
                        document.getElementById("message-list").deleteRow(42);
                    }
                }
                */
            }

            socket.on('initial data', (messages) => {
                console.log(messages);
                let tableData =[];
                for(const m of messages) {
                    tableData.push(displayMessage(m));
                }
                table.setData(tableData, true);
            });

            socket.on('all messages', (messages) => {
                console.log(messages);
                messageList.innerHTML = '';
                messages.forEach(function(m){displayMessage(m)});
            });

            socket.on('new message', (message) => {
                console.log(message);
                let tableData =[];
                for(const d of message.data) {
                    d['function'] = message.function;
                    d['sourceName']= message.sourceName;
                    tableData.push(displayMessage(d));
                }
                table.addData(tableData, true);
            });
        }

        main();

    </script>
</body>
</html>
