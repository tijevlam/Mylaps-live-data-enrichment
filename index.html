<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MYLAPS T&S TCP-IP Monitor</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.5.0/build/global/luxon.min.js"></script>
    <link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
    <link href="https://history.hollandtriathlon.nl/assets/css/tabulator_materialize.css" rel="stylesheet">
    <link rel="stylesheet" href="https://challengealmere.s3.eu-west-1.amazonaws.com/2024/assets/css/mdb.css">
    <link rel="stylesheet" href="https://history.hollandtriathlon.nl/assets/css/all.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.0/css/all.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&amp;display=swap">
        <script>
        let countries;

        async function fetchCountries() {
            const response = await fetch('https://challengealmere.s3.eu-west-1.amazonaws.com/2023/countries2023.json');
            return response.json();
        }


        let domiciles;

        async function fetchDomiciles() {
            const response = await fetch('https://challengealmere.s3.eu-west-1.amazonaws.com/2023/domicilies2023.json');
            return response.json();
        }

        let startlist;
        async function fetchStartlist() {
            const response = await fetch('https://challengealmere.s3.eu-west-1.amazonaws.com/2023/startlist2023.json');
            return response.json();
        }

        let table;

    </script>
</head>
<body>
    <h1>MYLAPS T&S TCP-IP Monitor</h1>
    <div id="mylaps" class="table tabulator"></div>

    <!-- Edit Modal -->
    <div class="modal fade modal-lg" id="editRowFormModal" tabindex="-1" role="dialog" aria-labelledby="editFormTitle"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title w-100" id="editFormTitle">View Record</h4>
                    <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body"></div>
            </div>
        </div>
    </div>

    <script>
        const capitalize = s => s && s[0].toUpperCase() + s.slice(1);

        const decapitalize = s => s && s[0].toLowerCase() + s.slice(1);

        const decodeS = function (e, field, rowId) {
            try {
                return JSON.parse(String(e).replace(/&amp;/g, "&").replace(/&lt;/g, "<").replace(/&gt;/g, ">").replace(/&sect;/g, "$").replace(/&copy;/g, "Â©").replace(/&quot;/g, '"').replace(/&#39;/g, "'").replace(/&#45;/g, "-").replace(/&nbsp;/g, " "))
            } catch (err) {
                debug(e, field, rowId, err)
                return ''
            }
        }
        async function main(){
            countries = await fetchCountries();
            domiciles = await fetchDomiciles();
            startlist = await fetchStartlist();


            table = new Tabulator("#mylaps", {

                height:"100%",
                maxHeight:"100%",
                pagination:"local",
                paginationSize:20,
                paginationSizeSelector:false,
                responsiveLayout: "collapse",
                responsiveLayoutCollapseStartOpen: false,
                autoColumns: true,
                autoColumnsDefinitions: function (definitions) {
                    definitions.forEach((column) => {
                        column.title = capitalize(column.field);


                        if(['bib', 'name', 'sourceName', 'cat', 'laps', 'time', 'raceTime'].includes(column.field)){
                            column.responsive = 0;
                            column.visible = true;
                        } else if(['wave'].includes(column.field)){
                            column.visible = true;
                            column.responsive = 2;
                        } else {
                            column.visible = false;
                            column.responsive = 3;
                        }


                        if(['function', 'info', 'chipcode'].includes(column.field)){
                            column.visible = false;
                        }

                        if(['bib'].includes(column.field)){
                            column.sorter = "number";
                        } else {
                            column.sorter = "string";
                        }

                    });

                    return definitions;
                },
                responsiveLayoutCollapseFormatter: function (data) {
                    //debug(data)
                    //data - an array of objects containing the column title and value for each cell

                    let basicInfo = ["uniqueName", "maidenName", "firstName", "lastName", "initials", "fullName", "gender", "domicile", "country", "cat", "catNk", "catOnk", "status", "birthdate", "age", "athleteId", "club"];
                    let raceInfo = ["year", "bibnr", "swimDist", "bikeDist", "runDist", "raceType", "ekWk", "onk", "ekNk", "raceType", "nk"];
                    let timeInfo = ["raceTime", "swimTime", "bikeTime", "runTime", "afterBikeTime", "t2", "t1", "penaltyTime"];

                    let riContent = ``;
                    let biContent = ``;
                    let tiContent = ``;
                    let ssContent = ``;
                    let siContent = ``;
                    let posContent = ``;

                    let rowId;

                    data.forEach(function (col) {
                        if (['moderated', 'edits', 'lastUpdatedAt', 'files', 'moderators', 'id', 'mdFinishes', 'ldFinishes'].includes(col.field)) {

                        }
                        if (col.field === "index") {
                            rowId = col.value;
                        } //console.log|(rowId)}
                        // if(col.value.trim() == "" || !col.value || col.value == "&nbsp;"){

                        // } else {
                        if (col.field === "id" || col.field === "index") {

                        } else if (basicInfo.includes(col.field)) {
                            biContent += `<dt class="col-sm-2 "><small>${capitalize(col.title)}</small></dt><dd class="col-sm-2"><small>${col.value === "&nbsp;" ? '<span class="text-muted opacity-40">N/A</span>' : col.value}</small></dd>`;
                        } else if (raceInfo.includes(col.field)) {
                            riContent += `<dt class="col-sm-2"><small>${capitalize(col.title)}</small></dt><dd class="col-sm-2"><small>${col.value === "&nbsp;" ? '<span class="text-muted opacity-40">N/A</span>' : col.value}</small></dd>`;
                        } else if (timeInfo.includes(col.field)) {
                            tiContent += `<dt class="col-sm-2"><small>${capitalize(col.title)}</small></dt><dd class="col-sm-2"><small>${col.value === "&nbsp;" ? '<span class="text-muted opacity-40">N/A</span>' : col.value}</small></dd>`;
                        } else if (col.field === "subSplits") {

                            let subSplits = (col.value.length > 0 && col.value != "&nbsp;" ) ? decodeS(col.value, col.field, rowId) : '';
                            // debug(subSplits);

                            if (typeof (subSplits) === "object") {
                                if (subSplits.swim && Object.keys(subSplits.swim).length > 0) {
                                    for (const [key, value] of Object.entries(subSplits.swim)) {
                                        ssContent += `<dt class="col-sm-2"><i class="fas fa-swimmer me-2"></i><small>${capitalize(key)}</small></dt><dd class="col-sm-2"><small>${value}</small></dd>`;
                                    }
                                }
                                if (subSplits.bike && Object.keys(subSplits.bike).length > 0) {
                                    for (const [key, value] of Object.entries(subSplits.bike)) {
                                        ssContent += `<dt class="col-sm-2"><i class="fas fa-biking me-2"></i><small>${capitalize(key)}</small></dt><dd class="col-sm-2"><small>${value}</small></dd>`;
                                    }
                                }
                                if (subSplits.run && Object.keys(subSplits.run).length > 0) {
                                    for (const [key, value] of Object.entries(subSplits.run)) {
                                        ssContent += `<dt class="col-sm-2"><i class="fas fa-running me-2"></i><small>${capitalize(key)}</small></dt><dd class="col-sm-2"><small>${value}</small></dd>`;
                                    }
                                }
                            }
                        } else if (col.field === "speakerInfo") {

                            let speakerInfo = (col.value.length > 0 && col.value != "&nbsp;" )? decodeS(col.value, col.field, rowId) : '';
                            if (typeof (speakerInfo) === "object") {
                                for (const [key, value] of Object.entries(speakerInfo)) {
                                    siContent += `<dt class="col-sm-2"><i class="far fa-clipboard me-2"></i><small>${capitalize(key)}</small></dt><dd class="col-sm-10"><small>${value}</small></dd>`;
                                }
                            }
                        } else {
                            posContent += `<dt class="col-sm-2"><small>${capitalize(col.title)}</small></dt><dd class="col-sm-2"><small>${col.value === "&nbsp;" ? '<span class="text-muted opacity-40">N/A</span>' : col.value}</small></dd>`;
                        }

                        // }
                    });

                    let cardGroup = document.createElement("div");
                    cardGroup.style.padding = "20px";
                    cardGroup.innerHTML = `<!-- Tabs navs -->
                    <ul class="nav nav-tabs mb-3 border-bottom" id="collaps-${rowId}" role="tablist">
                    <li class="nav-item" role="presentation">
                    <a
                    class="nav-link active"
                    id="collaps-${rowId}-tab-1"
                    data-mdb-toggle="tab"
                    href="#collaps-${rowId}-tabs-1"
                    role="tab"
                    aria-controls="collaps-${rowId}-tabs-1"
                    aria-selected="true"
                    ><i class="fas fa-running me-2"></i> Basic Info</a>
                    </li>
                    <li class="nav-item" role="presentation">
                    <a
                    class="nav-link"
                    id="collaps-${rowId}-tab-2"
                    data-mdb-toggle="tab"
                    href="#collaps-${rowId}-tabs-2"
                    role="tab"
                    aria-controls="collaps-${rowId}-tabs-2"
                    aria-selected="false"
                    ><i class="far fa-calendar me-2"></i> Race Info</a>
                    </li>
                    <li class="nav-item" role="presentation">
                    <a
                    class="nav-link"
                    id="collaps-${rowId}-tab-3"
                    data-mdb-toggle="tab"
                    href="#collaps-${rowId}-tabs-3"
                    role="tab"
                    aria-controls="collaps-${rowId}-tabs-3"
                    aria-selected="false"
                    ><i class="far fa-clock me-2"></i> Time Info</a>
                    </li>
                    <li class="nav-item ${ssContent.length > 2 ? '' : 'hidden'}" style="${ssContent.length > 2 ? '' : 'display:none;'}" role="presentation">
                    <a
                    class="nav-link"
                    id="collaps-${rowId}-tab-4"
                    data-mdb-toggle="tab"
                    href="#collaps-${rowId}-tabs-4"
                    role="tab"
                    aria-controls="collaps-${rowId}-tabs-4"
                    aria-selected="false"
                    style=""
                    ><i class="fas fa-stopwatch me-2"></i> SubSplits</a>
                    </li>
                    <li class="nav-item" role="presentation">
                    <a
                    class="nav-link"
                    id="collaps-${rowId}-tab-5"
                    data-mdb-toggle="tab"
                    href="#collaps-${rowId}-tabs-5"
                    role="tab"
                    aria-controls="collaps-${rowId}-tabs-5"
                    aria-selected="false"
                    ><i class="fas fa-cubes me-2"></i> Positions</a>
                    </li>
                    <li class="nav-item" role="presentation">
                    <a
                    class="nav-link ${siContent.length > 0 ? '' : 'disabled'}"
                    id="collaps-${rowId}-tab-6"
                    data-mdb-toggle="tab"
                    href="#collaps-${rowId}-tabs-6"
                    role="tab"
                    aria-controls="collaps-${rowId}-tabs-6"
                    aria-selected="false"
                    style="${siContent.length > 0 ? '' : 'opacity:0.5;'}"
                    ><i class="fas fa-bullhorn me-2"></i> SpeakerInfo</a>
                    </li>
                    </ul>
                        <!-- Tabs navs -->

                        <!-- Tabs content -->
                    <div class="tab-content" id="collaps-${rowId}-content">
                    <div class="tab-pane fade show active"  id="collaps-${rowId}-tabs-1" role="tabpanel" aria-labelledby="collaps-${rowId}-tab-1">
                    <dl class="row" style="padding-top: 15px; padding-left:35px">${biContent}</dl>
                    </div>
                    <div class="tab-pane fade" id="collaps-${rowId}-tabs-2" role="tabpanel" aria-labelledby="collaps-${rowId}-tab-2">
                    <dl class="row" style="padding-top: 15px; padding-left:35px">${riContent}</dl>
                    </div>
                    <div class="tab-pane fade" id="collaps-${rowId}-tabs-3" role="tabpanel" aria-labelledby="collaps-${rowId}-tab-3">
                    <dl class="row" style="padding-top: 15px; padding-left:35px"> ${tiContent}</dl>
                    </div>
                    <div class="tab-pane fade" id="collaps-${rowId}-tabs-4" role="tabpanel" aria-labelledby="collaps-${rowId}-tab-4">
                    <dl class="row" style="padding-top: 15px; padding-left:35px">${ssContent}</dl>
                    </div>
                    <div class="tab-pane fade" id="collaps-${rowId}-tabs-5" role="tabpanel" aria-labelledby="collaps-${rowId}-tab-5">
                    <dl class="row" style="padding-top: 15px; padding-left:35px">${posContent}</dl>
                    </div>
                    <div class="tab-pane fade" id="collaps-${rowId}-tabs-6" role="tabpanel" aria-labelledby="collaps-${rowId}-tab-6">
                    <dl class="row" style="padding-top: 15px; padding-left:35px">${siContent}</dl>
                    </div>
                    </div>
                        <!-- Tabs content -->`


                    return Object.keys(data).length ? cardGroup : "";
                }
            });

            table.on('build', function() {


                table.addColumn({title: "Speaker Info", field: "si", responsive: 0, headerSort: false, formatter: function (cell, formatterParams, onRendered) {
                        cell.getRow(); // get row component
                        let si = '';
                        if (cell.getRow().getData()?.history) {
                            si += `<img src="https://challengealmere.s3.eu-west-1.amazonaws.com/2024/assets/img/challenge_icon.png" width="20" style="margin-right: 10px; padding:0;">`;
                        }
                        if (cell.getRow().getData()?.worldTriProfile) {
                            si += `<img src="https://challengealmere.s3.eu-west-1.amazonaws.com/2024/assets/img/world-triathlon.png" width="20" style="margin-right: 10px; padding:0;">`;
                        }
                        if (cell.getRow().getData()?.trirating) {
                            si += `<span class="icon chartup"></span>`;
                        }
                        // add gelreman
                        if (cell.getRow().getData()?.gelreman) {
                            si += `<img src="https://challengealmere.s3.eu-west-1.amazonaws.com/2024/assets/img/gelreman_icon.png" width="20" style="margin-right: 10px; padding:0;">`;
                        }
                        // add frysman
                        if (cell.getRow().getData()?.frysman) {
                            si += `<img src="https://challengealmere.s3.eu-west-1.amazonaws.com/2024/assets/img/frysman_icon.png" width="20" style="margin-right: 10px; padding:0;">`;
                        }
                        return si
                    }}, false);


                table.addColumn({
                    title: "",
                    headerSort: false, /*cellClick: function(){  },*/
                    responsive: 0,
                    cssClass: "actionCol",
                    formatter: function (cell, formatterParams, onRendered) {
                        // ${yrd[cell.getRow().getData().year] && yrd[cell.getRow().getData().year].CompleteData ? 'disabled' : ''}
                        return `<button class="btn btn-primary btn-floating btn-sm ripple" style="" data-mdb-toggle="modal" data-mdb-target="#editRowFormModal" data-mdb-rowId="${cell.getRow().getData().index}">
                                    <i class="far fa-edit" data-mdb-toggle="modal" data-mdb-target="#editRowFormModal" data-mdb-rowId="${cell.getRow().getData().index}"></i>
                                ` //return the contents of the cell;
                    }
                });


            });

            const socket = io();
            const messageList = document.getElementById('message-list');

            function displayMessage(message) {
                let tableBody = document.querySelector('#message-list tbody');
                let cTime = luxon.DateTime.fromISO(`2024-09-14T${message.t}`);
                let startTime = luxon.DateTime.fromISO("2024-09-14T07:00:00.000");

                function formatTime(seconds) {
                    const hours = Math.floor(seconds / 3600);
                    const minutes = Math.floor((seconds % 3600) / 60);
                    const remainingSeconds = Math.floor(seconds % 60);

                    const formattedHours = String(hours).padStart(2, '0');
                    const formattedMinutes = String(minutes).padStart(2, '0');
                    const formattedSeconds = String(remainingSeconds).padStart(2, '0');

                    return `${formattedHours}:${formattedMinutes}:${formattedSeconds}`;
                }


                let pdata = {
                    bib: message.Bib,
                    chipcode: message.c,
                    function: message.function,
                    sourceName: message.sourceName,
                    name: message.Name,
                    wave: message.Wave,
                    cat: message.Cat,
                    laps: message.l,
                    time: message.t ? message.t.split(".")[0] : "",
                    raceTime: formatTime(cTime.diff(startTime, 'seconds').toObject().seconds),
                    info: message.Info
                };

                if (startlist.find(s => s.bibnr == message.Bib)) {
                    Object.assign(pdata, startlist.find(s => s.bibnr == message.Bib));
                }

                 return pdata;


                /*
                const row = document.createElement('tr');
                row.innerHTML = `<td>${message.b}</td>
                    <td>${message.c}</td>
                    <td>${message.function}</td>
                    <td>${message.sourceName}</td>
                    <td>&nbsp;</td>
                    <td>${message.l}</td>
                    <td>${message.t ? message.t.split(".")[0] : ""}</td>
                    <td>${formatTime(cTime.diff(startTime, 'seconds').toObject().seconds)}</td>`;
                tableBody.prepend(row);

                if ( document.getElementById("message-list").rows.length > 41) {
                    if(document.getElementById("message-list").rows[42]) {
                        document.getElementById("message-list").deleteRow(42);
                    }
                }
                */
            }

            socket.on('initial data', (messages) => {
                console.log(messages);
                let tableData =[];
                for(const m of messages) {
                    tableData.push(displayMessage(m));
                }
                table.setData(tableData, true);
            });

            socket.on('all messages', (messages) => {
                console.log(messages);
                messageList.innerHTML = '';
                messages.forEach(function(m){displayMessage(m)});
            });

            socket.on('new message', (message) => {
                console.log(message);
                let tableData =[];
                for(const d of message.data) {
                    d['function'] = message.function;
                    d['sourceName']= message.sourceName;
                    tableData.push(displayMessage(d));
                }
                table.addData(tableData, true);
            });
        }

        main();

    </script>
    <script type="text/javascript" src="https://history.hollandtriathlon.nl/assets/js/popper.min.js"></script>
    <script type="text/javascript" src="https://history.hollandtriathlon.nl/assets/js/mdb.min.js"></script>
<style>
    tr.year:nth-child(even) {background: #CCC}
    tr.year:nth-child(odd) {background: #FFF}

    td, th{
        padding: 5px;
    }

    .almereRecord{
        background-color: pink !important;
    }

    @font-face {font-family: "Font Awesome 6 Pro Thin";
        src: url("assets/css/1e66caed7f0d4a1bc39c8c2426573134.eot"); /* IE9*/
        src: url("assets/css/1e66caed7f0d4a1bc39c8c2426573134.eot?#iefix") format("embedded-opentype"), /* IE6-IE8 */
        url("assets/css/1e66caed7f0d4a1bc39c8c2426573134.woff2") format("woff2"), /* chromeãfirefox */
        url("assets/css/1e66caed7f0d4a1bc39c8c2426573134.woff") format("woff"), /* chromeãfirefox */
        url("assets/css/1e66caed7f0d4a1bc39c8c2426573134.ttf") format("truetype"), /* chromeãfirefoxãoperaãSafari, Android, iOS 4.2+*/
        url("assets/css/1e66caed7f0d4a1bc39c8c2426573134.svg#Font Awesome 6 Pro Thin") format("svg"); /* iOS 4.1- */
    }

    .icon{
        color: #000;
        line-height: 1.2em;
        font-family: "Font Awesome 6 Pro Thin"!important;
        font-size: 22px;
        /*background-color: #FFF;*/
        border-top-width: 0px;
        border-right-width: 0px;
        border-bottom-width: 0px;
        border-left-width: 0px;
    }

    .swim:before{
        content: "\f5c4"
    }
    .bike:before{
        content: "\f84a";
    }
    .run:before{
        content: "\f70c";
    }
    .medal:before{
        content: "\f5a2";
    }
    .ranking:before{
        content: "\e561";
    }
    .chartup:before{
        content: "\e0e5";
    }
    .megaphone:before{
        content:  "\f0a1";
    }
    .space-left{
        margin-left: 15px;
    }
</style>

</body>
</html>
