<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MYLAPS T&S TCP-IP Monitor</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.5.0/build/global/luxon.min.js"></script>
    <link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
    <link href="https://history.hollandtriathlon.nl/assets/css/tabulator_materialize.css" rel="stylesheet">
    <link rel="stylesheet" href="https://challengealmere.s3.eu-west-1.amazonaws.com/2024/assets/css/mdb.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.0/css/all.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&amp;display=swap">
        <script>
        let countries;

        async function fetchCountries() {
            const response = await fetch('https://challengealmere.s3.eu-west-1.amazonaws.com/2023/countries2023.json');
            return response.json();
        }


        let domiciles;

        async function fetchDomiciles() {
            const response = await fetch('https://challengealmere.s3.eu-west-1.amazonaws.com/2023/domicilies2023.json');
            return response.json();
        }

        let startlist;
        async function fetchStartlist() {
            const response = await fetch('https://challengealmere.s3.eu-west-1.amazonaws.com/2023/startlist2023.json');
            return response.json();
        }

        let table;

    </script>
</head>
<body>
    <h1>MYLAPS T&S TCP-IP Monitor</h1>
    <div id="mylaps" class="table tabulator"></div>
    <script>
        async function main(){
            countries = await fetchCountries();
            domiciles = await fetchDomiciles();
            startlist = await fetchStartlist();


            table = new Tabulator("#mylaps", {
                columns:[
                    {title:"Bib", field:"bib", sorter:"number" },
                    {title:"Chip Code", field:"chipcode", sorter:"alphanum", visible:false },
                    {title:"Function", field:"function", sorter:"string", visible:false },
                    {title:"Source Name", field:"sourceName", sorter:"string"},
                    {title:"Name", field:"name", sorter:"string"},
                    {title:"Wave", field:"wave", sorter:"string"},
                    {title:"Cat", field:"cat", sorter:"string"},
                    {title:"Laps", field:"laps", sorter:"number"},
                    {title:"Time", field:"time", sorter:"time"},
                    {title:"Race Time", field:"raceTime", sorter:"time"},
                    {title:"Info", field:"info", sorter:"string", visible:false},
                    {title:"Speaker Info", field: "si", formatter:function(cell, formatterParams, onRendered){
                            cell.getRow(); // get row component
                            let si ='';
                            if(cell.getRow().getData()?.history) {
                                si += `<img src="https://challengealmere.s3.eu-west-1.amazonaws.com/2024/assets/img/challenge_icon.png" width="20" style="margin-right: 10px; padding:0;">`;
                            }
                            if(cell.getRow().getData()?.worldTriProfile) {
                                si += `<img src="https://challengealmere.s3.eu-west-1.amazonaws.com/2024/assets/img/world-triathlon.png" width="20" style="margin-right: 10px; padding:0;">`;
                            }
                            if(cell.getRow().getData()?.trirating) {
                                si += `<span class="icon chartup"></span>`;
                            }
                            // add gelreman
                            if(cell.getRow().getData()?.gelreman) {
                                si += `<img src="https://challengealmere.s3.eu-west-1.amazonaws.com/2024/assets/img/gelreman_icon.png" width="20" style="margin-right: 10px; padding:0;">`;
                            }
                            // add frysman
                            if(cell.getRow().getData()?.frysman) {
                                si += `<img src="https://challengealmere.s3.eu-west-1.amazonaws.com/2024/assets/img/frysman_icon.png" width="20" style="margin-right: 10px; padding:0;">`;
                            }
                            return si
                        },
                    }
                ],
                height:"100%",
                maxHeight:"100%",
                pagination:"local",
                paginationSize:20,
                paginationSizeSelector:false,
                responsiveLayout: "collapse",
                responsiveLayoutCollapseStartOpen: false,
                responsiveLayoutCollapseFormatter: function (data) {
                    //debug(data)
                    //data - an array of objects containing the column title and value for each cell

                    let basicInfo = ["uniqueName", "maidenName", "firstName", "lastName", "initials", "fullName", "gender", "domicile", "country", "cat", "catNk", "catOnk", "status", "birthdate", "age", "athleteId", "club"];
                    let raceInfo = ["year", "bibnr", "swimDist", "bikeDist", "runDist", "raceType", "ekWk", "onk", "ekNk", "raceType", "nk"];
                    let timeInfo = ["raceTime", "swimTime", "bikeTime", "runTime", "afterBikeTime", "t2", "t1", "penaltyTime"];

                    let riContent = ``;
                    let biContent = ``;
                    let tiContent = ``;
                    let ssContent = ``;
                    let siContent = ``;
                    let posContent = ``;

                    let rowId;

                    data.forEach(function (col) {
                        if (['moderated', 'edits', 'lastUpdatedAt', 'files', 'moderators', 'id', 'mdFinishes', 'ldFinishes'].includes(col.field)) {

                        }
                        if (col.field === "index") {
                            rowId = col.value;
                        } //console.log|(rowId)}
                        // if(col.value.trim() == "" || !col.value || col.value == "&nbsp;"){

                        // } else {
                        if (col.field === "id" || col.field === "index") {

                        } else if (basicInfo.includes(col.field)) {
                            biContent += `<dt class="col-sm-2 "><small>${capitalize(col.title)}</small></dt><dd class="col-sm-2"><small>${col.value === "&nbsp;" ? '<span class="text-muted opacity-40">N/A</span>' : col.value}</small></dd>`;
                        } else if (raceInfo.includes(col.field)) {
                            riContent += `<dt class="col-sm-2"><small>${capitalize(col.title)}</small></dt><dd class="col-sm-2"><small>${col.value === "&nbsp;" ? '<span class="text-muted opacity-40">N/A</span>' : col.value}</small></dd>`;
                        } else if (timeInfo.includes(col.field)) {
                            tiContent += `<dt class="col-sm-2"><small>${capitalize(col.title)}</small></dt><dd class="col-sm-2"><small>${col.value === "&nbsp;" ? '<span class="text-muted opacity-40">N/A</span>' : col.value}</small></dd>`;
                        } else if (col.field === "subSplits") {

                            let subSplits = (col.value.length > 0 && col.value != "&nbsp;" ) ? decodeS(col.value, col.field, rowId) : '';
                            // debug(subSplits);

                            if (typeof (subSplits) === "object") {
                                if (subSplits.swim && Object.keys(subSplits.swim).length > 0) {
                                    for (const [key, value] of Object.entries(subSplits.swim)) {
                                        ssContent += `<dt class="col-sm-2"><i class="fas fa-swimmer me-2"></i><small>${capitalize(key)}</small></dt><dd class="col-sm-2"><small>${value}</small></dd>`;
                                    }
                                }
                                if (subSplits.bike && Object.keys(subSplits.bike).length > 0) {
                                    for (const [key, value] of Object.entries(subSplits.bike)) {
                                        ssContent += `<dt class="col-sm-2"><i class="fas fa-biking me-2"></i><small>${capitalize(key)}</small></dt><dd class="col-sm-2"><small>${value}</small></dd>`;
                                    }
                                }
                                if (subSplits.run && Object.keys(subSplits.run).length > 0) {
                                    for (const [key, value] of Object.entries(subSplits.run)) {
                                        ssContent += `<dt class="col-sm-2"><i class="fas fa-running me-2"></i><small>${capitalize(key)}</small></dt><dd class="col-sm-2"><small>${value}</small></dd>`;
                                    }
                                }
                            }
                        } else if (col.field === "speakerInfo") {

                            let speakerInfo = (col.value.length > 0 && col.value != "&nbsp;" )? decodeS(col.value, col.field, rowId) : '';
                            if (typeof (speakerInfo) === "object") {
                                for (const [key, value] of Object.entries(speakerInfo)) {
                                    siContent += `<dt class="col-sm-2"><i class="far fa-clipboard me-2"></i><small>${capitalize(key)}</small></dt><dd class="col-sm-10"><small>${value}</small></dd>`;
                                }
                            }
                        } else {
                            posContent += `<dt class="col-sm-2"><small>${capitalize(col.title)}</small></dt><dd class="col-sm-2"><small>${col.value === "&nbsp;" ? '<span class="text-muted opacity-40">N/A</span>' : col.value}</small></dd>`;
                        }

                        // }
                    });

                    let cardGroup = document.createElement("div");
                    cardGroup.style.padding = "20px";
                    cardGroup.innerHTML = `<!-- Tabs navs -->
                    <ul class="nav nav-tabs mb-3 border-bottom" id="collaps-${rowId}" role="tablist">
                    <li class="nav-item" role="presentation">
                    <a
                    class="nav-link active"
                    id="collaps-${rowId}-tab-1"
                    data-mdb-toggle="tab"
                    href="#collaps-${rowId}-tabs-1"
                    role="tab"
                    aria-controls="collaps-${rowId}-tabs-1"
                    aria-selected="true"
                    ><i class="fas fa-running me-2"></i> Basic Info</a>
                    </li>
                    <li class="nav-item" role="presentation">
                    <a
                    class="nav-link"
                    id="collaps-${rowId}-tab-2"
                    data-mdb-toggle="tab"
                    href="#collaps-${rowId}-tabs-2"
                    role="tab"
                    aria-controls="collaps-${rowId}-tabs-2"
                    aria-selected="false"
                    ><i class="far fa-calendar me-2"></i> Race Info</a>
                    </li>
                    <li class="nav-item" role="presentation">
                    <a
                    class="nav-link"
                    id="collaps-${rowId}-tab-3"
                    data-mdb-toggle="tab"
                    href="#collaps-${rowId}-tabs-3"
                    role="tab"
                    aria-controls="collaps-${rowId}-tabs-3"
                    aria-selected="false"
                    ><i class="far fa-clock me-2"></i> Time Info</a>
                    </li>
                    <li class="nav-item ${ssContent.length > 2 ? '' : 'hidden'}" style="${ssContent.length > 2 ? '' : 'display:none;'}" role="presentation">
                    <a
                    class="nav-link"
                    id="collaps-${rowId}-tab-4"
                    data-mdb-toggle="tab"
                    href="#collaps-${rowId}-tabs-4"
                    role="tab"
                    aria-controls="collaps-${rowId}-tabs-4"
                    aria-selected="false"
                    style=""
                    ><i class="fas fa-stopwatch me-2"></i> SubSplits</a>
                    </li>
                    <li class="nav-item" role="presentation">
                    <a
                    class="nav-link"
                    id="collaps-${rowId}-tab-5"
                    data-mdb-toggle="tab"
                    href="#collaps-${rowId}-tabs-5"
                    role="tab"
                    aria-controls="collaps-${rowId}-tabs-5"
                    aria-selected="false"
                    ><i class="fas fa-cubes me-2"></i> Positions</a>
                    </li>
                    <li class="nav-item" role="presentation">
                    <a
                    class="nav-link ${siContent.length > 0 ? '' : 'disabled'}"
                    id="collaps-${rowId}-tab-6"
                    data-mdb-toggle="tab"
                    href="#collaps-${rowId}-tabs-6"
                    role="tab"
                    aria-controls="collaps-${rowId}-tabs-6"
                    aria-selected="false"
                    style="${siContent.length > 0 ? '' : 'opacity:0.5;'}"
                    ><i class="fas fa-bullhorn me-2"></i> SpeakerInfo</a>
                    </li>
                    </ul>
                        <!-- Tabs navs -->

                        <!-- Tabs content -->
                    <div class="tab-content" id="collaps-${rowId}-content">
                    <div class="tab-pane fade show active"  id="collaps-${rowId}-tabs-1" role="tabpanel" aria-labelledby="collaps-${rowId}-tab-1">
                    <dl class="row" style="padding-top: 15px; padding-left:35px">${biContent}</dl>
                    </div>
                    <div class="tab-pane fade" id="collaps-${rowId}-tabs-2" role="tabpanel" aria-labelledby="collaps-${rowId}-tab-2">
                    <dl class="row" style="padding-top: 15px; padding-left:35px">${riContent}</dl>
                    </div>
                    <div class="tab-pane fade" id="collaps-${rowId}-tabs-3" role="tabpanel" aria-labelledby="collaps-${rowId}-tab-3">
                    <dl class="row" style="padding-top: 15px; padding-left:35px"> ${tiContent}</dl>
                    </div>
                    <div class="tab-pane fade" id="collaps-${rowId}-tabs-4" role="tabpanel" aria-labelledby="collaps-${rowId}-tab-4">
                    <dl class="row" style="padding-top: 15px; padding-left:35px">${ssContent}</dl>
                    </div>
                    <div class="tab-pane fade" id="collaps-${rowId}-tabs-5" role="tabpanel" aria-labelledby="collaps-${rowId}-tab-5">
                    <dl class="row" style="padding-top: 15px; padding-left:35px">${posContent}</dl>
                    </div>
                    <div class="tab-pane fade" id="collaps-${rowId}-tabs-6" role="tabpanel" aria-labelledby="collaps-${rowId}-tab-6">
                    <dl class="row" style="padding-top: 15px; padding-left:35px">${siContent}</dl>
                    </div>
                    </div>
                        <!-- Tabs content -->`


                    return Object.keys(data).length ? cardGroup : "";
                }
            });

            const socket = io();
            const messageList = document.getElementById('message-list');

            function displayMessage(message) {
                let tableBody = document.querySelector('#message-list tbody');
                let cTime = luxon.DateTime.fromISO(`2024-09-14T${message.t}`);
                let startTime = luxon.DateTime.fromISO("2024-09-14T07:00:00.000");

                function formatTime(seconds) {
                    const hours = Math.floor(seconds / 3600);
                    const minutes = Math.floor((seconds % 3600) / 60);
                    const remainingSeconds = Math.floor(seconds % 60);

                    const formattedHours = String(hours).padStart(2, '0');
                    const formattedMinutes = String(minutes).padStart(2, '0');
                    const formattedSeconds = String(remainingSeconds).padStart(2, '0');

                    return `${formattedHours}:${formattedMinutes}:${formattedSeconds}`;
                }


                let pdata = {
                    bib: message.Bib,
                    chipcode: message.c,
                    function: message.function,
                    sourceName: message.sourceName,
                    name: message.Name,
                    wave: message.Wave,
                    cat: message.Cat,
                    laps: message.l,
                    time: message.t ? message.t.split(".")[0] : "",
                    raceTime: formatTime(cTime.diff(startTime, 'seconds').toObject().seconds),
                    info: message.Info
                };

                if (startlist.find(s => s.bibnr == message.Bib)) {
                    Object.assign(pdata, startlist.find(s => s.bibnr == message.Bib));
                }

                 return pdata;


                /*
                const row = document.createElement('tr');
                row.innerHTML = `<td>${message.b}</td>
                    <td>${message.c}</td>
                    <td>${message.function}</td>
                    <td>${message.sourceName}</td>
                    <td>&nbsp;</td>
                    <td>${message.l}</td>
                    <td>${message.t ? message.t.split(".")[0] : ""}</td>
                    <td>${formatTime(cTime.diff(startTime, 'seconds').toObject().seconds)}</td>`;
                tableBody.prepend(row);

                if ( document.getElementById("message-list").rows.length > 41) {
                    if(document.getElementById("message-list").rows[42]) {
                        document.getElementById("message-list").deleteRow(42);
                    }
                }
                */
            }

            socket.on('initial data', (messages) => {
                console.log(messages);
                let tableData =[];
                for(const m of messages) {
                    tableData.push(displayMessage(m));
                }
                table.setData(tableData, true);
            });

            socket.on('all messages', (messages) => {
                console.log(messages);
                messageList.innerHTML = '';
                messages.forEach(function(m){displayMessage(m)});
            });

            socket.on('new message', (message) => {
                console.log(message);
                let tableData =[];
                for(const d of message.data) {
                    d['function'] = message.function;
                    d['sourceName']= message.sourceName;
                    tableData.push(displayMessage(d));
                }
                table.addData(tableData, true);
            });
        }

        main();

    </script>
</body>
</html>
